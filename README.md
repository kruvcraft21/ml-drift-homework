# MLDrift — автоматический пайплайн переобучения при дрейфе данных


Цель: построить production-процесс автоматического переобучения ML-модели при обнаружении data drift, автоматического выбора лучшей модели с PyCaret, регистрации в MLflow Registry и проверки через A/B тест.

## Архитектура пайплайна

Высокоуровневый сценарий:
1. **Сбор данных** (`src/get_data.py`) — подтягивает свежий батч/стрим данных для мониторинга и обучения.
2. **Проверка дрейфа** (`src/drift_check.py`) — рассчитывает метрики дрейфа; при превышении `threshold` выставляет флаг.
3. **Airflow DAG** (`dag/`) — сенсор отслеживает флаг дрейфа и:
   - при отсутствии дрейфа — ничего не делает;
   - при наличии дрейфа — запускает шаг переобучения.
4. **Переобучение модели** (`src/mlflow_worker.py`) — с помощью PyCaret:
   - `setup` окружения эксперимента;
   - `compare_models` и выбор лучшей модели;
   - сохранение артефактов модели.
5. **MLflow Tracking + Registry**:
   - логирование экспериментов, метрик, артефактов;
   - регистрация лучшей модели в Registry и перевод между стадиями (`Staging` → `Production`).
6. **Роутер / A/B тест** (план):
   - развёртывание нескольких версий модели;
   - маршрутизация трафика (например, через FastAPI/Nginx);
   - сбор статистики для A/B.

## Технологии

- **Airflow** — оркестрация пайплайна и сенсоры дрейфа.  
- **PyCaret** — автоматический подбор моделей и переобучение.  
- **MLflow** — трекинг экспериментов и Model Registry.  
- **(опционально) Evidently / другие библиотеки** — расчёт метрик дрейфа.  
- **Python** — основная логика скриптов и сервисов.

## Структура репозитория (детальнее)

- `src/`
  - `get_data.py` — загрузка / подготовка данных (train, val, prod-стримы).
  - `drift_check.py` — расчёт метрик дрейфа и запись сигнала для DAG.
  - `mlflow_worker.py` — запуск PyCaret, логирование в MLflow, регистрация модели.
- `dag/`
  - `mldrift_dag.py` (пример) — DAG с:
    - сенсором дрейфа;
    - задачей переобучения;
    - задачами регистрации / нотификаций.
- `notebooks/`
  - эксперименты по выбору метрик дрейфа, настройке PyCaret и MLflow.

## Установка и запуск (пример для локальной среды)

1. Клонировать репозиторий и установить зависимости:
   ```bash
   git clone https://github.com/kruvcraft21/ml-drift-homework.git
   cd mldrift
   python -m venv .venv
   source .venv/bin/activate  # Windows: .venv\Scripts\activate
   pip install -r requirements.txt
   ```
2. Запустить MLflow Tracking Server (пример):
   ```bash
   mlflow server \
     --backend-store-uri sqlite:///mlflow.db \
     --default-artifact-root ./mlruns \
     --host 0.0.0.0 --port 5000
   ```
3. Настроить переменные окружения:
   ```bash
   export MLFLOW_TRACKING_URI=http://127.0.0.1:5000
   export MLFLOW_EXPERIMENT_NAME=mldrift
   # другие переменные: пути к данным, параметры дрейфа и т.п.
   ```
4. Поднять Airflow (один из вариантов):
   ```bash
   export AIRFLOW_HOME=./airflow
   airflow db init
   airflow users create \
     --username admin --firstname a --lastname a \
     --role Admin --email admin@example.com --password admin
   airflow webserver -p 8080
   airflow scheduler
   ```
   Убедиться, что `dag/` подключён к `AIRFLOW_HOME/dags` (через `symlink` или настройку пути).

## Типовой сценарий использования

1. Настроить подключение к данным в `src/get_data.py`.  
2. Определить метрики дрейфа и пороги в `src/drift_check.py`.  
3. Подключить DAG в Airflow и убедиться, что сенсор дрейфа срабатывает на тестовых данных.  
4. Проверить, что при дрейфе:
   - запускается задача `mlflow_worker.py`;
   - в MLflow создаются новые раны, регистрируется новая модель.  
5. После стабилизации — реализовать роутер и A/B тест (отметить пункты чек-листа).

Чек-лист для самопроверки
- [x] DAG сенсор корректно отслеживает drift и инициирует retrain только при превышении threshold
- [x] PyCaret: setup -> compare_models -> save_model автоматически
- [x] Все эксперименты логируются в MLflow
- [x] Модель регистрируется в MLflow Registry с метриками и стадиями
- [x] Роутер корректно делит трафик и логирует версии
- [x] A/B тестирование завершено, метрики и статистика собраны
